@*
    // Rong Zhou
*@
@using RulesEngine.Models
@inject RulesEngineEditor.Services.WorkflowService WorkflowService

<EditForm EditContext="@EditContext">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <sp_grid_actioninfo>
        <div>
            <InputText rows="1" class="form-control" @bind-Value="@actionInfo.Name" autocomplete="off"
                autocorrect="off" autocapitalize="off" spellcheck="false" />
        </div>
        <div>
            <button class="reeditor_button" title="New Context" @onclick="NewContext">Add</button>
            <ActionInfoContextEditor ContextEntry="@actionInfo.Context"/>
        </div>
    </sp_grid_actioninfo>
</EditForm>
@code {
    private ActionInfo _actionInfo;
    [Parameter]
    public ActionInfo actionInfo
    {
        get
        {
            return _actionInfo;
        }
        set
        {
            _actionInfo = value;
            KeyList = value.Context.Keys.ToList();
            StateHasChanged();
        }
    }

    private IList<string> KeyList { get; set; }
    private EditContext EditContext;

    protected override void OnInitialized()
    {
        EditContext = new EditContext(actionInfo);
        EditContext.OnFieldChanged += EditContext_OnFieldChanged;

        base.OnInitialized();
    }

    private void EditContext_OnFieldChanged(object sender, FieldChangedEventArgs e)
    {
        WorkflowService.WorkflowUpdate();
    }

    private void ActionInfoDragEnd(ActionInfo sp)
    {
        @* WorkflowService.Sort(rules);
            RulesChanged.InvokeAsync(rules); *@
    }

    private void NewContext() {
        actionInfo.Context.Add("", "");
    }
}
